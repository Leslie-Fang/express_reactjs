var express=require("express"),router=express.Router(),my=require("../databases/mysql_api"),bcrypt=require("bcrypt"),redis=require("redis"),session=require("express-session"),redisStore=require("connect-redis")(session),saltRounds=10;router.use("/myCenter",function(o,e,s){console.log(o.session),1==o.session.islogin?s():(console.log("Not login!"),console.log(o.session.islogin),e.redirect("/login"))}),router.get("/",function(o,e){e.render("main")}),router.get("/myCenter",function(o,e){e.send("This is my personal center page.")}),router.get("/login",function(o,e){e.render("login")}),router.get("/signup",function(o,e){e.render("signup")}),router.post("/login",function(o,e,s){console.log(o.param("username")),console.log(o.param("password"));var r={username:o.param("username"),password:o.param("password")};console.log(r),my.validateifUserExist(o,r,e,function(o){if(console.log(o),console.log("In callback!"),"nouser"==o.state)return e.send(o);s()})},function(o,e){console.log("checkout password!"),console.log(o.param("username")),console.log(o.param("password"));var s={username:o.param("username"),password:o.param("password")};my.checkpassword(o,s,e,function(o){return console.log(o),console.log("In callback!"),e.send(o)})}),router.post("/signup",function(o,e,s){console.log(o.param("username")),console.log(o.param("password"));var r={username:o.param("username"),password:o.param("password")};console.log(r),my.validateifUserExist(o,r,e,function(o){if(console.log(o),console.log("In callback!"),"nouser"!=o.state)return e.send(o);s()})},function(o,e){bcrypt.hash(o.param("password"),saltRounds,function(s,r){console.log("save new user"),console.log(o.param("username")),console.log(o.param("password")),console.log(r);var n={username:o.param("username"),password:r};my.saveuser(o,n,e,function(o){return console.log(o),console.log("In callback!"),e.send(o)})})}),router.post("/logout",function(o,e,s){o.session.destroy(function(o){return e.send({state:"confirm_logout"})})}),module.exports=router;