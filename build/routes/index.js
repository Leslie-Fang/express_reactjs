var express=require("express"),router=express.Router(),my=require("../databases/mysql_api"),bcrypt=require("bcrypt"),saltRounds=10;router.use("/main",function(o,e,s){1==o.cookies.islogin?s():(console.log("Not login!"),console.log(o.cookies.islogin),e.redirect("/login"))}),router.get("/main",function(o,e){e.send("main")}),router.get("/login",function(o,e){e.render("login")}),router.get("/signup",function(o,e){e.render("signup")}),router.post("/login",function(o,e,s){console.log(o.param("username")),console.log(o.param("password"));var r={username:o.param("username"),password:o.param("password")};console.log(r),my.validateifUserExist(o,r,e,function(o){if(console.log(o),console.log("In callback!"),"nouser"==o.state)return e.send(o);s()})},function(o,e){console.log("checkout password!"),console.log(o.param("username")),console.log(o.param("password"));var s={username:o.param("username"),password:o.param("password")};my.checkpassword(o,s,e,function(o){return console.log(o),console.log("In callback!"),e.send(o)})}),router.post("/signup",function(o,e,s){console.log(o.param("username")),console.log(o.param("password"));var r={username:o.param("username"),password:o.param("password")};console.log(r),my.validateifUserExist(o,r,e,function(o){if(console.log(o),console.log("In callback!"),"nouser"!=o.state)return e.send(o);s()})},function(o,e){bcrypt.hash(o.param("password"),saltRounds,function(s,r){console.log("save new user"),console.log(o.param("username")),console.log(o.param("password")),console.log(r);var n={username:o.param("username"),password:r};my.saveuser(o,n,e,function(o){return console.log(o),console.log("In callback!"),e.send(o)})})}),module.exports=router;