var express=require("express"),router=express.Router(),my=require("../databases/mysql_api"),bcrypt=require("bcrypt"),redis=require("redis"),session=require("express-session"),redisStore=require("connect-redis")(session),saltRounds=10;router.use("/myCenter",function(e,r,s){1==e.session.islogin?s():r.redirect("/login")}),router.get("/",function(e,r){r.render("main")}),router.get("/myCenter",function(e,r){r.send("This is my personal center page.")}),router.get("/login",function(e,r){r.render("login")}),router.get("/signup",function(e,r){r.render("signup")}),router.post("/login",function(e,r,s){var n={username:e.param("username"),password:e.param("password")};my.validateifUserExist(e,n,r,function(e){if("nouser"==e.state)return r.send(e);s()})},function(e,r){var s={username:e.param("username"),password:e.param("password")};my.checkpassword(e,s,r,function(e){return r.send(e)})}),router.post("/signup",function(e,r,s){var n={username:e.param("username"),password:e.param("password")};my.validateifUserExist(e,n,r,function(e){if("nouser"!=e.state)return r.send(e);s()})},function(e,r){bcrypt.hash(e.param("password"),saltRounds,function(s,n){var o={username:e.param("username"),password:n};my.saveuser(e,o,r,function(e){return r.send(e)})})}),router.post("/logout",function(e,r,s){r.clearCookie("username"),e.session.destroy(function(e){return r.send({state:"confirm_logout"})})}),module.exports=router;