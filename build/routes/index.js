var express=require("express"),router=express.Router(),my=require("../databases/mysql_api"),bcrypt=require("bcrypt"),redis=require("redis"),session=require("express-session"),redisStore=require("connect-redis")(session),saltRounds=10;router.use("/main",function(o,s,e){console.log(o.session),1==o.session.islogin?e():(console.log("Not login!"),console.log(o.session.islogin),s.redirect("/login"))}),router.get("/main",function(o,s){s.send("main")}),router.get("/login",function(o,s){s.render("login")}),router.get("/signup",function(o,s){s.render("signup")}),router.post("/login",function(o,s,e){console.log(o.param("username")),console.log(o.param("password"));var r={username:o.param("username"),password:o.param("password")};console.log(r),my.validateifUserExist(o,r,s,function(o){if(console.log(o),console.log("In callback!"),"nouser"==o.state)return s.send(o);e()})},function(o,s){console.log("checkout password!"),console.log(o.param("username")),console.log(o.param("password"));var e={username:o.param("username"),password:o.param("password")};my.checkpassword(o,e,s,function(o){return console.log(o),console.log("In callback!"),s.send(o)})}),router.post("/signup",function(o,s,e){console.log(o.param("username")),console.log(o.param("password"));var r={username:o.param("username"),password:o.param("password")};console.log(r),my.validateifUserExist(o,r,s,function(o){if(console.log(o),console.log("In callback!"),"nouser"!=o.state)return s.send(o);e()})},function(o,s){bcrypt.hash(o.param("password"),saltRounds,function(e,r){console.log("save new user"),console.log(o.param("username")),console.log(o.param("password")),console.log(r);var n={username:o.param("username"),password:r};my.saveuser(o,n,s,function(o){return console.log(o),console.log("In callback!"),s.send(o)})})}),router.post("/logout",function(o,s,e){o.session.destroy(function(o){return s.send({state:"confirm_logout"})})}),module.exports=router;